{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <div class="card shadow p-4 rounded-4">
    <h3 class="mb-4">ğŸ” ØªØªØ¨Ø¹ Ø§Ù„Ø´Ø­Ù†Ø©</h3>

    <form method="get" class="row g-3 mb-4" id="tracking-form">
      <div class="col-md-8">
        <input type="text" name="code" id="code-input" class="form-control" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØªØ¨Ø¹ Ø£Ùˆ Ø§Ù…Ø³Ø­ QR" value="{{ code }}">
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">ğŸ” ØªØªØ¨Ø¹</button>
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-secondary w-100" onclick="startScan()">ğŸ“· QR</button>
      </div>
    </form>

    <div id="scanner" style="display:none;" class="mb-4">
      <video id="preview" width="100%" height="240" autoplay muted></video>
    </div>

    {% if tracking %}
      <div class="alert alert-info">
        <p><strong>Ø§Ù„Ù…Ù†ØªØ¬:</strong> {{ tracking.product_name }}</p>
        <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> {{ tracking.customer_name }}</p>
        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> <span class="badge bg-success">{{ tracking.get_status_display }}</span></p>
        <p><strong>Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†:</strong> {{ tracking.shipping_company|default:"-" }}</p>
        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†:</strong> {{ tracking.shipment_date }}</p>
        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…:</strong> {{ tracking.delivery_date|default:"-" }}</p>
        <p><strong>Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹:</strong> {{ movements.0.location|default:"ØºÙŠØ± Ù…ØªØ§Ø­" }}</p>
        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ø±ÙƒØ§Øª:</strong> {{ movements|length }}</p>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mt-3 mb-2">ğŸšš ØªØ­Ø±ÙƒØ§Øª Ø§Ù„Ø´Ø­Ù†Ø©</h5>
        <a class="btn btn-outline-primary btn-sm" href="https://wa.me/?text={{ request.build_absolute_uri }}">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØªØ¨Ø¹</a>
      </div>

      {% if movements %}
        <ul class="list-group">
          {% for m in movements %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ m.get_status_display }}</strong> â€“ {{ m.location }}
              </div>
              <span class="badge bg-secondary">{{ m.timestamp|date:"Y-m-d H:i" }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>
      {% endif %}

    {% elif code %}
      <div class="alert alert-danger">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¯Ø®Ù„.</div>
    {% endif %}
  </div>
</div>

<!-- âœ… Ø¯Ø¹Ù… QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
<script>
  function startScan() {
    document.getElementById("scanner").style.display = "block";
    const scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
    scanner.addListener('scan', function (content) {
      document.getElementById('code-input').value = content;
      document.getElementById('tracking-form').submit();
    });
    Instascan.Camera.getCameras().then(function (cameras) {
      if (cameras.length > 0) {
        scanner.start(cameras[0]);
      } else {
        alert('ğŸ“· Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§');
      }
    }).catch(function (e) {
      console.error(e);
      alert("ğŸ“µ ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
    });
  }
</script>
{% endblock %}
