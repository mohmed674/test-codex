{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <div class="card shadow p-4 rounded-4">
    <h3 class="mb-4">🔍 تتبع الشحنة</h3>

    <form method="get" class="row g-3 mb-4" id="tracking-form">
      <div class="col-md-8">
        <input type="text" name="code" id="code-input" class="form-control" placeholder="ادخل كود التتبع أو امسح QR" value="{{ code }}">
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">🔍 تتبع</button>
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-secondary w-100" onclick="startScan()">📷 QR</button>
      </div>
    </form>

    <div id="scanner" style="display:none;" class="mb-4">
      <video id="preview" width="100%" height="240" autoplay muted></video>
    </div>

    {% if tracking %}
      <div class="alert alert-info">
        <p><strong>المنتج:</strong> {{ tracking.product_name }}</p>
        <p><strong>العميل:</strong> {{ tracking.customer_name }}</p>
        <p><strong>الحالة الحالية:</strong> <span class="badge bg-success">{{ tracking.get_status_display }}</span></p>
        <p><strong>شركة الشحن:</strong> {{ tracking.shipping_company|default:"-" }}</p>
        <p><strong>تاريخ الشحن:</strong> {{ tracking.shipment_date }}</p>
        <p><strong>تاريخ التسليم:</strong> {{ tracking.delivery_date|default:"-" }}</p>
        <p><strong>آخر موقع:</strong> {{ movements.0.location|default:"غير متاح" }}</p>
        <p><strong>عدد التحركات:</strong> {{ movements|length }}</p>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mt-3 mb-2">🚚 تحركات الشحنة</h5>
        <a class="btn btn-outline-primary btn-sm" href="https://wa.me/?text={{ request.build_absolute_uri }}">📤 مشاركة التتبع</a>
      </div>

      {% if movements %}
        <ul class="list-group">
          {% for m in movements %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ m.get_status_display }}</strong> – {{ m.location }}
              </div>
              <span class="badge bg-secondary">{{ m.timestamp|date:"Y-m-d H:i" }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">لا توجد تحركات مسجلة حتى الآن.</p>
      {% endif %}

    {% elif code %}
      <div class="alert alert-danger">❌ لم يتم العثور على كود التتبع المدخل.</div>
    {% endif %}
  </div>
</div>

<!-- ✅ دعم QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
<script>
  function startScan() {
    document.getElementById("scanner").style.display = "block";
    const scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
    scanner.addListener('scan', function (content) {
      document.getElementById('code-input').value = content;
      document.getElementById('tracking-form').submit();
    });
    Instascan.Camera.getCameras().then(function (cameras) {
      if (cameras.length > 0) {
        scanner.start(cameras[0]);
      } else {
        alert('📷 لا يوجد كاميرا');
      }
    }).catch(function (e) {
      console.error(e);
      alert("📵 فشل في تشغيل الكاميرا");
    });
  }
</script>
{% endblock %}
