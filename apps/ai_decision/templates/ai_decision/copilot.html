{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "Ù…Ø³Ø§Ø¹Ø¯ ERP Ø§Ù„Ø°ÙƒÙŠ" %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/copilot.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.2"></script>
{% endblock %}

{% block page_content %}
<div class="copilot-container">
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="m-0">ğŸ¤– {% trans "Ù…Ø³Ø§Ø¹Ø¯ ERP Ø§Ù„Ø°ÙƒÙŠ" %}</h2>
    <button type="button" id="localThemeToggle" class="btn btn-dark btn-sm">
      ğŸŒ™/â˜€ï¸ {% trans "ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹" %}
    </button>
  </div>

  <!-- KPIs -->
  <div class="kpi-cards">
    <div class="kpi-card">
      <h3>{% trans "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±" %}</h3>
      <p>{{ total_sales|floatformat:2 }} {% trans "Ø¬Ù†ÙŠÙ‡" %}</p>
    </div>
    <div class="kpi-card">
      <h3>{% trans "Ø£Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª" %}</h3>
      <ul>
        {% for item in top_products %}
          <li>{{ item.product__name }} - {{ item.qty }} {% trans "ÙˆØ­Ø¯Ø©" %}</li>
        {% empty %}
          <li class="text-muted">{% trans "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª" %}</li>
        {% endfor %}
      </ul>
    </div>
    <div class="kpi-card">
      <h3>{% trans "Ù…ÙˆØ±Ø¯ÙˆÙ† Ù…ØªØ£Ø®Ø±ÙˆÙ†" %}</h3>
      <ul>
        {% for sup in delayed_suppliers %}
          <li>{{ sup.supplier__name }} - {{ sup.delays }} {% trans "Ù…Ø±Ø©" %}</li>
        {% empty %}
          <li class="text-muted">{% trans "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹" %}</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Chart -->
  <div class="chart-container">
    <canvas id="salesChart" aria-label="{% trans 'Ù…Ø®Ø·Ø· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ' %}" role="img"></canvas>
  </div>

  <!-- Quick suggestions -->
  <div class="suggestions">
    <button hx-get="{% url 'copilot_query' %}?query=Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹" hx-target="#response">{% trans "Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹" %}</button>
    <button hx-get="{% url 'copilot_query' %}?query=Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹" hx-target="#response">{% trans "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…Ø¨ÙŠØ¹Ø§Ù‹" %}</button>
    <button hx-get="{% url 'copilot_query' %}?query=Ù…ÙˆØ±Ø¯ÙŠÙ† Ù…ØªØ£Ø®Ø±ÙŠÙ†" hx-target="#response">{% trans "Ù…ÙˆØ±Ø¯ÙˆÙ† Ù…ØªØ£Ø®Ø±ÙˆÙ†" %}</button>
  </div>

  <!-- Query form -->
  <form hx-get="{% url 'copilot_query' %}" hx-target="#response" class="query-form" role="search" aria-label="{% trans 'Ø§Ø³Ø£Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯' %}">
    <input type="text" name="query" placeholder="{% trans 'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...' %}" required aria-required="true">
    <button type="submit">{% trans "Ø£Ø±Ø³Ù„" %}</button>
  </form>

  <!-- Responses -->
  <div id="response" class="response-box" aria-live="polite"></div>
  <div id="chat-box" class="response-box mt-3"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/copilot_chat.js' %}"></script>
<script src="{% static 'js/copilot_voice.js' %}"></script>
<script>
  (function(){
    var el = document.getElementById('salesChart');
    if(!el) return;
    var ctx = el.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['{% trans "ÙŠÙ†Ø§ÙŠØ±" %}', '{% trans "ÙØ¨Ø±Ø§ÙŠØ±" %}', '{% trans "Ù…Ø§Ø±Ø³" %}', '{% trans "Ø£Ø¨Ø±ÙŠÙ„" %}'],
        datasets: [{
          label: '{% trans "Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©" %}',
          data: [120000, 150000, 180000, 210000]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          title: { display: true, text: '{% trans "Ù…Ø®Ø·Ø· Ù…Ø¨ÙŠØ¹Ø§Øª Ø´Ù‡Ø±ÙŠ" %}' }
        },
        scales: { y: { beginAtZero: true } }
      }
    });
  })();

  (function(){
    var localBtn = document.getElementById('localThemeToggle');
    if(!localBtn) return;
    localBtn.addEventListener('click', function(){
      var globalBtn = document.getElementById('themeToggle');
      if (globalBtn) { globalBtn.click(); return; }
      var cur = document.documentElement.getAttribute('data-theme') || 'light';
      var next = cur === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      try { localStorage.setItem('erp_theme', next); } catch(e){}
    });
  })();
</script>
{% endblock %}
