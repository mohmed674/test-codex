{% extends "core/base.html" %}
{% load i18n static form_filters %}

{% block title %}{% if edit_mode %}{% trans "تعديل منتج" %}{% else %}{% trans "إضافة منتج" %}{% endif %}{% endblock %}
{% block header_title %}📝 {% if edit_mode %}{% trans "نموذج تعديل المنتج" %}{% else %}{% trans "نموذج إضافة منتج" %}{% endif %}{% endblock %}
{% block breadcrumbs %}<a href="{% url 'core:launcher' %}">{% trans "التطبيقات" %}</a> / <a href="{% url 'products:product_list' %}">{% trans "المنتجات" %}</a> / {% if edit_mode %}{% trans "تعديل" %}{% else %}{% trans "إضافة" %}{% endif %}{% endblock %}

{% block extra_head %}
  <style>
    /* تحسينات مرئية دون المساس بالمنطق */
    .form-label:has(+ .form-control[required]),
    .form-label:has(+ .form-select[required]),
    .form-check-input[required] + .form-check-label {
      position: relative;
    }
    .form-label:has(+ .form-control[required])::after,
    .form-label:has(+ .form-select[required])::after,
    .form-check-input[required] + .form-check-label::after {
      content:" *";
      color:#dc2626;
      font-weight:700;
    }
    .erp-help { color:#6b7280; font-size:.85rem; }
    .preview-tile { border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px; background:#fff; }
    :root[data-theme="dark"] .preview-tile { background:#161b2b; border-color:rgba(255,255,255,.08); }
    .drop-hint { border:1px dashed rgba(0,0,0,.2); border-radius:10px; padding:10px; text-align:center; font-size:.9rem; color:#6b7280; }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 pb-4">
  <div class="card">
    <div class="card-body">

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <form method="post" enctype="multipart/form-data" novalidate id="productForm">
        {% csrf_token %}
        <div class="row">
          {# عرض الحقول ديناميكيًا مع أنماط Bootstrap — الإبقاء على منطقك كاملاً #}
          {% for field in form.visible_fields %}
            {% if field.errors %}
              <div class="col-12">
                <div class="text-danger small mb-1">{{ field.errors }}</div>
              </div>
            {% endif %}

            {% if field.name == "description" or field.name == "notes" or field.name == "details" %}
              <div class="col-12 mb-3">
            {% else %}
              <div class="col-md-6 mb-3">
            {% endif %}
                <label for="{{ field.id_for_label }}" class="form-label">
                  {{ field.label|default:field.name|capfirst }}
                </label>

                {# تطبيق كلاس مناسب حسب نوع الودجت #}
                {% if field.field.widget.input_type == "select" %}
                  {{ field|add_class:"form-select" }}
                {% elif field.field.widget.input_type == "checkbox" %}
                  <div class="form-check">
                    {{ field|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.help_text }}</label>
                  </div>
                {% else %}
                  {{ field|add_class:"form-control" }}
                {% endif %}

                {% if field.help_text and field.field.widget.input_type != "checkbox" %}
                  <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
              </div>
          {% endfor %}
        </div>

        {# معاينات اختيارية للصور (إضافة دون المساس بالحقول) #}
        {% if form.image or form.qr_code %}
        <hr>
        <div class="row g-3">
          {% if form.image %}
          <div class="col-md-6">
            <div class="preview-tile">
              <div class="fw-semibold mb-2">{% trans "معاينة الصورة" %}</div>
              <div class="drop-hint mb-2">{% trans "يمكنك سحب الصورة وإفلاتها في خانة التحميل أعلاه" %}</div>
              <img id="erp-preview-image" src="{% if form.instance and form.instance.image %}{{ form.instance.image.url }}{% else %}{% static 'icons/icon-192x192.png' %}{% endif %}"
                   alt="preview" style="max-width:100%;max-height:220px;object-fit:contain;opacity:.95">
              <div class="erp-help mt-2">{% trans "تدعم PNG/JPG/WebP. يُفضّل أبعاد مربعة 512×512." %}</div>
            </div>
          </div>
          {% endif %}
          {% if form.qr_code %}
          <div class="col-md-6">
            <div class="preview-tile">
              <div class="fw-semibold mb-2">{% trans "معاينة QR" %}</div>
              <img id="erp-preview-qr" src="{% if form.instance and form.instance.qr_code %}{{ form.instance.qr_code.url }}{% else %}{% static 'icons/icon-192x192.png' %}{% endif %}"
                   alt="qr" style="max-width:100%;max-height:220px;object-fit:contain;opacity:.95">
              <div class="erp-help mt-2">{% trans "يُولّد تلقائيًا من البيانات—سيُحدَّث بعد الحفظ إذا تغيّرت الحقول المؤثرة." %}</div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <div class="d-flex justify-content-center gap-2 mt-3">
          <button type="submit" class="btn btn-primary" id="saveBtn">
            💾 {% trans "حفظ" %}
          </button>
          <a href="{% url 'products:product_list' %}" class="btn btn-secondary">
            🔙 {% trans "رجوع" %}
          </a>
        </div>
      </form>

    </div>
  </div>
</div>

{# تعزيزات واجهة غير دخيلة #}
<script>
(function(){
  const form = document.getElementById('productForm');
  const saveBtn = document.getElementById('saveBtn');

  // منع الإرسال المتكرر
  form && form.addEventListener('submit', function(){
    if (saveBtn) { saveBtn.disabled = true; saveBtn.setAttribute('aria-busy','true'); }
  });

  // اختصار Ctrl/Cmd+S للحفظ
  window.addEventListener('keydown', function(e){
    const isMac = navigator.platform.toUpperCase().includes('MAC');
    if ((isMac ? e.metaKey : e.ctrlKey) && e.key.toLowerCase() === 's'){
      e.preventDefault();
      form && form.requestSubmit && form.requestSubmit();
    }
  });

  // معاينة صور الحقول المعروفة إن وُجدت
  function bindPreview(inputName, imgId){
    const input = document.querySelector('input[name="'+inputName+'"][type="file"]');
    const img = document.getElementById(imgId);
    if (!input || !img) return;
    input.addEventListener('change', function(){
      const f = this.files && this.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      img.src = url;
      img.style.opacity = 1;
    });
  }
  bindPreview('image', 'erp-preview-image');
  bindPreview('qr_code', 'erp-preview-qr');

  // عدادات بسيطة للنصوص الطويلة (description/notes/details) إن وُجدت
  ['description','notes','details'].forEach(function(name){
    const el = document.querySelector('[name="'+name+'"]');
    if (!el) return;
    const info = document.createElement('div');
    info.className = 'erp-help mt-1';
    el.insertAdjacentElement('afterend', info);
    const max = el.getAttribute('maxlength');
    function upd(){
      const len = el.value.length;
      info.textContent = max ? (len + ' / ' + max) : (len + ' {% filter escape %}{% trans "حرف" %}{% endfilter %}');
    }
    el.addEventListener('input', upd); upd();
  });

  // تحذير خروج عند وجود تعديلات
  let dirty = false;
  form && form.addEventListener('input', () => { dirty = true; });
  window.addEventListener('beforeunload', function(e){
    if (!dirty) return;
    e.preventDefault();
    e.returnValue = '';
  });
})();
</script>
{% endblock %}
