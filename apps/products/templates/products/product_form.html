{% extends "core/base.html" %}
{% load i18n static form_filters %}

{% block title %}{% if edit_mode %}{% trans "ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬" %}{% else %}{% trans "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬" %}{% endif %}{% endblock %}
{% block header_title %}ğŸ“ {% if edit_mode %}{% trans "Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬" %}{% else %}{% trans "Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬" %}{% endif %}{% endblock %}
{% block breadcrumbs %}<a href="{% url 'core:launcher' %}">{% trans "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª" %}</a> / <a href="{% url 'products:product_list' %}">{% trans "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" %}</a> / {% if edit_mode %}{% trans "ØªØ¹Ø¯ÙŠÙ„" %}{% else %}{% trans "Ø¥Ø¶Ø§ÙØ©" %}{% endif %}{% endblock %}

{% block extra_head %}
  <style>
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù…Ø±Ø¦ÙŠØ© Ø¯ÙˆÙ† Ø§Ù„Ù…Ø³Ø§Ø³ Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚ */
    .form-label:has(+ .form-control[required]),
    .form-label:has(+ .form-select[required]),
    .form-check-input[required] + .form-check-label {
      position: relative;
    }
    .form-label:has(+ .form-control[required])::after,
    .form-label:has(+ .form-select[required])::after,
    .form-check-input[required] + .form-check-label::after {
      content:" *";
      color:#dc2626;
      font-weight:700;
    }
    .erp-help { color:#6b7280; font-size:.85rem; }
    .preview-tile { border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px; background:#fff; }
    :root[data-theme="dark"] .preview-tile { background:#161b2b; border-color:rgba(255,255,255,.08); }
    .drop-hint { border:1px dashed rgba(0,0,0,.2); border-radius:10px; padding:10px; text-align:center; font-size:.9rem; color:#6b7280; }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 pb-4">
  <div class="card">
    <div class="card-body">

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <form method="post" enctype="multipart/form-data" novalidate id="productForm">
        {% csrf_token %}
        <div class="row">
          {# Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ Ù…Ø¹ Ø£Ù†Ù…Ø§Ø· Bootstrap â€” Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ùƒ ÙƒØ§Ù…Ù„Ø§Ù‹ #}
          {% for field in form.visible_fields %}
            {% if field.errors %}
              <div class="col-12">
                <div class="text-danger small mb-1">{{ field.errors }}</div>
              </div>
            {% endif %}

            {% if field.name == "description" or field.name == "notes" or field.name == "details" %}
              <div class="col-12 mb-3">
            {% else %}
              <div class="col-md-6 mb-3">
            {% endif %}
                <label for="{{ field.id_for_label }}" class="form-label">
                  {{ field.label|default:field.name|capfirst }}
                </label>

                {# ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ„Ø§Ø³ Ù…Ù†Ø§Ø³Ø¨ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¯Ø¬Øª #}
                {% if field.field.widget.input_type == "select" %}
                  {{ field|add_class:"form-select" }}
                {% elif field.field.widget.input_type == "checkbox" %}
                  <div class="form-check">
                    {{ field|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.help_text }}</label>
                  </div>
                {% else %}
                  {{ field|add_class:"form-control" }}
                {% endif %}

                {% if field.help_text and field.field.widget.input_type != "checkbox" %}
                  <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
              </div>
          {% endfor %}
        </div>

        {# Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ù„ØµÙˆØ± (Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆÙ† Ø§Ù„Ù…Ø³Ø§Ø³ Ø¨Ø§Ù„Ø­Ù‚ÙˆÙ„) #}
        {% if form.image or form.qr_code %}
        <hr>
        <div class="row g-3">
          {% if form.image %}
          <div class="col-md-6">
            <div class="preview-tile">
              <div class="fw-semibold mb-2">{% trans "Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©" %}</div>
              <div class="drop-hint mb-2">{% trans "ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¥ÙÙ„Ø§ØªÙ‡Ø§ ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ø¹Ù„Ø§Ù‡" %}</div>
              <img id="erp-preview-image" src="{% if form.instance and form.instance.image %}{{ form.instance.image.url }}{% else %}{% static 'icons/icon-192x192.png' %}{% endif %}"
                   alt="preview" style="max-width:100%;max-height:220px;object-fit:contain;opacity:.95">
              <div class="erp-help mt-2">{% trans "ØªØ¯Ø¹Ù… PNG/JPG/WebP. ÙŠÙÙØ¶Ù‘Ù„ Ø£Ø¨Ø¹Ø§Ø¯ Ù…Ø±Ø¨Ø¹Ø© 512Ã—512." %}</div>
            </div>
          </div>
          {% endif %}
          {% if form.qr_code %}
          <div class="col-md-6">
            <div class="preview-tile">
              <div class="fw-semibold mb-2">{% trans "Ù…Ø¹Ø§ÙŠÙ†Ø© QR" %}</div>
              <img id="erp-preview-qr" src="{% if form.instance and form.instance.qr_code %}{{ form.instance.qr_code.url }}{% else %}{% static 'icons/icon-192x192.png' %}{% endif %}"
                   alt="qr" style="max-width:100%;max-height:220px;object-fit:contain;opacity:.95">
              <div class="erp-help mt-2">{% trans "ÙŠÙÙˆÙ„Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€”Ø³ÙŠÙØ­Ø¯Ù‘ÙØ« Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø¥Ø°Ø§ ØªØºÙŠÙ‘Ø±Øª Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø«Ø±Ø©." %}</div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <div class="d-flex justify-content-center gap-2 mt-3">
          <button type="submit" class="btn btn-primary" id="saveBtn">
            ğŸ’¾ {% trans "Ø­ÙØ¸" %}
          </button>
          <a href="{% url 'products:product_list' %}" class="btn btn-secondary">
            ğŸ”™ {% trans "Ø±Ø¬ÙˆØ¹" %}
          </a>
        </div>
      </form>

    </div>
  </div>
</div>

{# ØªØ¹Ø²ÙŠØ²Ø§Øª ÙˆØ§Ø¬Ù‡Ø© ØºÙŠØ± Ø¯Ø®ÙŠÙ„Ø© #}
<script>
(function(){
  const form = document.getElementById('productForm');
  const saveBtn = document.getElementById('saveBtn');

  // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±
  form && form.addEventListener('submit', function(){
    if (saveBtn) { saveBtn.disabled = true; saveBtn.setAttribute('aria-busy','true'); }
  });

  // Ø§Ø®ØªØµØ§Ø± Ctrl/Cmd+S Ù„Ù„Ø­ÙØ¸
  window.addEventListener('keydown', function(e){
    const isMac = navigator.platform.toUpperCase().includes('MAC');
    if ((isMac ? e.metaKey : e.ctrlKey) && e.key.toLowerCase() === 's'){
      e.preventDefault();
      form && form.requestSubmit && form.requestSubmit();
    }
  });

  // Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
  function bindPreview(inputName, imgId){
    const input = document.querySelector('input[name="'+inputName+'"][type="file"]');
    const img = document.getElementById(imgId);
    if (!input || !img) return;
    input.addEventListener('change', function(){
      const f = this.files && this.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      img.src = url;
      img.style.opacity = 1;
    });
  }
  bindPreview('image', 'erp-preview-image');
  bindPreview('qr_code', 'erp-preview-qr');

  // Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ø·ÙˆÙŠÙ„Ø© (description/notes/details) Ø¥Ù† ÙˆÙØ¬Ø¯Øª
  ['description','notes','details'].forEach(function(name){
    const el = document.querySelector('[name="'+name+'"]');
    if (!el) return;
    const info = document.createElement('div');
    info.className = 'erp-help mt-1';
    el.insertAdjacentElement('afterend', info);
    const max = el.getAttribute('maxlength');
    function upd(){
      const len = el.value.length;
      info.textContent = max ? (len + ' / ' + max) : (len + ' {% filter escape %}{% trans "Ø­Ø±Ù" %}{% endfilter %}');
    }
    el.addEventListener('input', upd); upd();
  });

  // ØªØ­Ø°ÙŠØ± Ø®Ø±ÙˆØ¬ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª
  let dirty = false;
  form && form.addEventListener('input', () => { dirty = true; });
  window.addEventListener('beforeunload', function(e){
    if (!dirty) return;
    e.preventDefault();
    e.returnValue = '';
  });
})();
</script>
{% endblock %}
